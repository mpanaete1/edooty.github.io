<h2>RH294 Red Hat System Administration III Automation with Ansible</h2>

[Home](index.html)

[toc]

##### Introducing Ansible

Open source automation platform. Programming language that allows for automating tasks on multiple hosts. Engine that runs Ansible Playbooks.



| Components                                    | Description                                                  |
| --------------------------------------------- | ------------------------------------------------------------ |
| [Inventories](#Building-an-Ansible-Inventory) | defines a collection of hosts that ansible will manage. You can define groups and child groups as well as set variables that apply to the hosts/groups that it defines |
| [Playbooks](#Implementing-Playbooks)          | used to run multiple, complex tasks against a set of targeted hosts |
| [Modules](#Running-Ad-Hoc-Commands) (`-m`)    | small programs that are executed to implement tasks          |
| OpenSSH or WinRM                              | Protocols used to connect to remote hosts, Linux / Windows   |
| Agent-less architecture                       | Ansible is installed on a control node and clients do not need any special agent software |
| [Arguments](#Running-Ad-Hoc-Commands) (`-a`)  | quoted string commands to run against modules. Read ansible-doc <module> for more information |



##### Installing Ansible

<a href="rh294.html">Top</a>

Ansible software only needs to be installed on the control node. Control node should be linux or unix. Windows is not supported. need Python3 or Python2

###### Pre-requisites

`yum list installed platform-python`

`subscription-manager repos --enable ansible-2-for-rhel-8-x86_64-rpms`

`subscription-manager refresh`

###### Install

`yum install ansible`

​	`ansible --version`

verify python version on host : `ansible -m setup localhost | grep ansible_python_version`



###### Managed Host requirements

​	Python 2.6 ^ or Python 3

​	specific modules may need newer python versions

​	`yum module install python36`

---



##### Deploying Ansible

[[Top](#RH294-Red-Hat-System-Administration-III-Automation-with-Ansible)](#RH294-Red-Hat-Enterprise-Linux-Automation-with-Ansible)

###### Building an Ansible Inventory

Inventories are a collection of hosts that Ansible will manage. There are two types:

​	**static**- defined by a text file

​	**dynamic**- generated by a script, using external information providers

<u>default location</u>: `/etc/ansible/hosts`

​				you can create one in your own directory



**INI style (most widely used)**

- list of host names or IP addresses on a single line. you can define groups, nested groups, and variables

- group names are in square brackets [ ] and you can specify ip or hostnames.  you can have multiple ips/hostnames in more than 1 group
- nested groups are in square brackets [all:children] with :children
- ranges are specified with [START:END]. make sure to use 01 or 1 for exact matching		

```
192.168.1.5

[webservers]  
web1.example.com	
192.168.1.3	
host8

[us]
192.168.3.4
host8

[all:children]
us
webservers

192.168.[4:7].[0:255]
server[01:10].server.com
[a:h].dns.server.com
```



###### Verify the Inventory

| Command                                 | Description                                           |
| --------------------------------------- | ----------------------------------------------------- |
| `ansible all --list-hosts`              | list all hosts/groups in inventory                    |
|                                         | `-i ` to specify what inventory to use(absolute path) |
| `ansible web1.example.com --list-hosts` | verify machine presence                               |
| `ansible <groupname> --list-hosts`      | list all hosts in a group                             |
| `ansible ungrouped --list-hosts`        | show all ungrouped hosts in inventory                 |



###### Location/Example of the Ansible Configuration Files

<a href="rh294.html">Top</a>

| Location                            | Description                                                  |
| ----------------------------------- | ------------------------------------------------------------ |
| `/etc/ansible/ansible.cfg`          | provided by the ansible package as a base config. This file is used if no other config file is found |
| `~/.ansible.cfg`                    | ansible looks for this file in users home directory. used instead of /etc/ansible/ansible.cfg and there is no ansible.cfg in the currently working directory |
| `./ansible.cfg`                     | if this file exists in the current working directory it is used instead of the global or users personal file. <u>This is best practice</u> |
| ANSIBLE_CONFIG environment variable | Ansible uses the config set in the environment variable instead of searching above locations. |

check config file : `ansible all --list-hosts -v`  config file used is at the top of output `-v`



<u>Configuration File Example:</u>

```
[defaults]                  	(make sure you use DEFAULTS not DEFAULT)
inventory = ./inventory     	(specify inventory file)
remote_user = <user>        	(what user is connecting to remote host)
ask_pass = true/false       	(ask for a password (sshkeys) or configure sudo/ssh) 

[privilege_escalation]      	(learn how to spell privilege)
become = true/false				(will your remote connection/cmds escalate privileges)
become_method = sudo			(run sudo to escalate)
become_user = root				(user to escalate to)
become_ask_pass = true/false	(ask for a password (sshkeys) or configure sudo/ssh)

# This is a Comment so is ;
```

**Required**

- Location of Inventory
- Protocol (SSH by default)
- remote user
- Privileged / Unprivileged  suders file `<username> ALL=(ALL) NOPASSWD:ALL`
- Prompt for a password (ssh-copy-id)

---



##### Running Ad Hoc Commands

<a href="rh294.html">Top</a>

Using the Ansible command to run ad hoc commands

`ansible host-pattern -m <module> [-a 'module arguments'] [-i inventory]`

| Option         | Description                                                  |
| -------------- | ------------------------------------------------------------ |
| *host-pattern* | specify the managed host on with to run commands. group or host |
| `-m`           | takes an argument the name of the module and Ansible should run on target hosts |
|                | modules are small programs that are executed to implement tasks |
| `-a`           | takes a list of those arguments as a quoted string to run against the module. Always use ' ' around arguments. `-a 'name=<name> uuid=2000 state=present'` |

Different colors for output, green changed, orange not changed. Also see in "changed= "

Run the ping command or any other commands against all hosts: `ansible all -m ping`

The command module allows you to execute remote commands

​			`ansible <host> -m command -a 'hostname'`



List all modules installed on the system: `ansible-doc -l`  you can `| grep <search>` for specific modules

​	get information/docs on specific module: `ansible-doc <module>`

​	notice some modules include **OPTIONS (= is mandatory)**

​			`-a 'name=<name> uuid=2000 state=present'`

​			state checks the remote system for present or absent. check options for default `ansible-doc`

<u>Most used modules:</u>

| Modules             | Description                                                  |
| ------------------- | ------------------------------------------------------------ |
| copy                | Copy a local file to the managed host                        |
| file                | Set permissions and other properties of files                |
| package             | Manage packages using autodetected package manager native to the operating system |
| package_facts       | collects the installed packages details on managed hosts     |
| yum_repository      | delcare a new repository within tasks                        |
| rpm_key             | key: http....                                                |
|                     | state: present                                               |
|                     | The yum_repository would follow this task                    |
| yum                 | Manage packages using the YUM package manager, does take lists |
| pip                 | Manage Python packages from PyPI                             |
| firewalld           | Manage arbitrary ports and services using                    |
| service             | Manage services                                              |
| systemd             | a better option for services. name, state, daemon-reload     |
| reboot              | reboot machine                                               |
| user                | Add, remove, and manage user accounts                        |
| generate_ssh_key    | :yes                                                         |
|                     | name: user                                                   |
|                     | ssh_key_bits: 2048                                           |
|                     | ssh_key_file: .ssh/id_rsa                                    |
| group               | manage groups                                                |
| known_host          | copy keys to remote servers                                  |
|                     | path, name, key                                              |
| authorized_key      | user, state, key "{{ lookup('file'), '/home/user1/.ssh/id_rsa.pub'  }}" |
|                     | lookup plugin allows for Ansible to access data from outside sources |
| get_url             | Download files over HTTP, HTTPS, or FTP                      |
| nmcli               | Manage networking                                            |
| uri                 | Interact with web services                                   |
| at, chron           | scheduling modules                                           |
| shell, command      | remote command execution                                     |
| parted              | supports partition managment. device, number, state, part_end: |
| lvg and lvol        | creation of logical, physical, volume groups                 |
|                     | vg: vg1 , pvs: /dev, pesize: 32                              |
|                     | vg: vg1, lv: lv1, size: 2g                                   |
| filesystem          | fstype: xfs, dev: /dev   create a filesystem                 |
| mount               | path, src, fstype, opts, dump, passno, state: mounted        |
| Networking role     | ansible_galaxy list \| grep network                          |
| network_provider    | nm                                                           |
| network_connections | name: eth0, type: ethernet, ip: \n  address: \n - <ip>, autoconnect, persistent_state |
| nmcli               | conn-name, ifname, type, ipv4, gw4, state. may need firewalld to allow connections |



You can define configuration settings within ad hoc commands

| Configuration   | Command-line option |
| --------------- | ------------------- |
| inventory       | `-i`                |
| remote_user     | `-u`                |
| become          | `-b`                |
| become_method   | `--become-method`   |
| become_user     | `--become-user`     |
| become_ask_pass | `-K`                |

---



##### Implementing Playbooks

<a href="rh294.html">Top</a>

Ansible Playbooks - used to run multiple, complex tasks against a set of targeted hosts. Written in YAML and saved as a .yml

​	a play - is an ordered set of tasks to run against hosts or series of items

​	a playbook - text file containing a list of one or more plays to run in a specific order



<u>Example Playbook</u>

Make sure playbooks use same indentation for each section. 

- data elements at the same level must have the same indentation
- items that are children of another item must be indented more that their parents
- plays are a collection of key-value pairs. 
- names are not required but <u>best practice</u>

```
---												(start of the playbook)
- name: Configure important user consistently	(defined lists, start with a -)	
  hosts: web1.example.com						(remote host/s to run tasks on (key))
  tasks:										(task list/ or single task (key))	
 	- name: newbie exists with UUID 4000		(name for your task. (list item))
 	  user:										(module to use for task)
 	  	name: newbie							(Options for the user module)
 	  	uid: 4000								(Options for the user module)
 	  	state: present							(Options for the user module)
 	  	
 	- name: httpd is installed					(second task name (list item))
 	  yum:										(module)	
 	  	name: httpd								(Options for the yum module)
 	  	state: present							(Options for the yum module)
 	  	
 	- name: web server is enabled				(antother task to check httpd)
 	  service:									(service module)
 	    name: httpd								(module options)
 	    enabled: true							(module options)
 	    
- name: Second Play								(multiple plays)
  hosts: web.example.com						
  remote_user: automation						(adding user attributes option)
  become: yes									(adding privilege escaltaion option)
  tasks: 
  	- name: first task
  	  service:
  	  	name: mariadb
  	  	enabled: true
	
	- name: latest version of packages
	  yum:
	  	name:
	  		- firewalld							(having multiple names in list)
	  		- httpd
  			- php
```

apply settings to vim (`~/.vimrc`) to make it easier to edit playbooks

​		`set number`

​		`syntax on`

​		`autocmd FileType yaml setlocal ai ts=2 sw=2 et cuc cc=3,5,7,9,11`

​		`hi ColorColumn ctermbg=black`



###### Running Playbooks

| Command                                      | Definition                |
| -------------------------------------------- | ------------------------- |
| `ansible-playbook --syntax-check <name.yml>` | check syntax verification |
| `ansible-playbook -C <name.yml>`             | perform a dry run         |
| `ansible-playbook <name.yml>`                | run a playbook            |

​	<u>Output:</u>	

```
play [name] ......

task [name]......

ok: [host]

changed: [host]

play recap....

host : ok=2 changed=1 unreachable=0 failed =0

```

###### Troubleshooting Playbooks

| Error/Info                                  | Syntax                                                       |
| ------------------------------------------- | ------------------------------------------------------------ |
| Log files (ansible does not log by default) | in `ansible.cfg` locate `log_path =` need to have write perms for the directory |
| Debug module                                | prints out value for certain variables/facts to stdout       |
|                                             | debug:                                                       |
|                                             | msg: "the hostname {{ ansible_facts['fqdn'] }}"              |
| Manage Errors                               | `--syntax-check`                                             |
|                                             | `--step`  will step through the playbook                     |
|                                             | `--start-at-task="Start service"` start execution at a specific task |
| Debugging                                   | Check output of playbook recap                               |
| Checking mode                               | `--check` run smoke tests on a playbook                      |
| ping hosts                                  | `-m ping`  you can try `--become` as well at the end to check errors |



---



##### Managing Variables 

<a href="rh294.html">Top</a>

variables can be used to store values that can then be used througout file in a Ansible project. 

start variables with letters and user underscores, no spaces.

###### Naming and Defining Variables

variable names must start with a letter and can only contain letters,numbers, and underscores

variables can be defined in three basic concepts

 - global scope: variables set from the command line or Ansible config
 - play scope: set in the play and related structures
 - host scope: set on host groups and indivdual hosts by the inventory

###### Setting variables in your playbook

```
---
- hosts: all						(Place a variable in a vars block in the beggining)
  vars:
  	user: joe
  	home: /home/joe
  	
- hosts: all						(define variables in an external file)
  var_file: 
  	- vars/users.yml

vars:								(Variable in a playbook)
	user: joe
	
tasks:
	- name: Creates the user {{ user }}
	  user:
	  	name: "{{ user }}"
```

###### Setting variables in the inventory file

```
[servers]									(define var for host variable)
server.example.com ansible_user=joe


[servers]									(define user group for the servers host group)
host1.example.com
host2.example.com

[servers:vars]								
user=joe
```

###### Using directories to populate host and group variables

Define group variables and host variables using directories

create two directories: `group_vars` and `host_vars` where your inventory file is

​		in `group_vars`:

​				create a file with the <u>name of group/s</u> in your invenotry file with the contents or your <variable names>

​		in `host_vars`:

​				create a file with the <u>name of the host/s</u> in your inventory file with the contents or your <variable names>

**Override variables**

`ansible-playbook <name>.yml -e "package=httpd"`



###### Capturing command output with registered Variables

using `register` statements to capture the output of a command. when this is ran the debug module is used to dump the value of the install_result to the terminal

```
---
- name: Installs a package and prints the result
  hosts: all
  tasks:
    - name: Install the package
       yum:
		 name: httpd
		 state: installed
	   register: install_result								(register value)
	   
	- debug: 										(debug shows variable on the screen)
	   var: install_result
```

---



##### Managing Secrets

<a href="rh294.html">Top</a>

###### Ansible Vault

Can be used to encrypt and decrypt and structured data file used by Ansible

| Command                                          | Description                                                  |
| ------------------------------------------------ | ------------------------------------------------------------ |
| `ansible-vault`                                  | create, edit, encrypyt, decrypt, and view files              |
| `ansible-vault create <name>.yml`                | prompts for a password , you can store password and it will be encrypted. |
| `ansible-vault view <name>.yml`                  | view encrypted file (prompted for password)                  |
| `echo <password> > vault-pass`                   | setup a password for ansible vault                           |
|                                                  | requires `chmod 0600 vault-pass`                             |
| `ansible-vault edit <name>.yml`                  | edit vault file                                              |
| `ansible-vault encrypt <name>.yml `              | encrypt single or multiple files                             |
| `ansible-vault decrypt <name>.yml`               | decrypt a single or multiple file                            |
| `--output=<name>.yml`                            | after a decrypt or encrypt change the name                   |
| `ansible-vault rekey <name>.yml`                 | change password on a file                                    |
| `ansible-playbook --vault-id @prompt <name>.yml` | vault playbook implementation                                |
|                                                  | `--ask-vault-pass`  Ansible versions earlier than 2.4 **(use this)** |
| `--vault-password-file=vault-pass`               | specify password file instead of prompting for a password    |

you can add <vault name> to your `host_vars` and `group_vars` to manage groups and hosts with ansible vault

---



##### Managing Facts

<a href="rh294.html">Top</a>

Vairables that are automatically discovered by ansible on the managed hosts. 

host-specific information. A way of getting the state of managed hosts and to determine what action to take based on that state.

`ansible_facts`  is setup with the ansible setup command `ansible <host> -m setup > ansible_facts`

​	`ansible_facts` has information on the hosts you run the `-m` on.

​	format: `{{ ansible_facts['<name>'] }}`	  

​	disable fact gathering  `gather_facts: no`

```
---
- hosts: all
  tasks:
	- name: Prints various Ansible facts
	  debug:
		msg: >
			The default IPv4 address of {{ ansible_facts['fqdn'] }}
			is {{ ansible_facts['default_ipv4.address']['address'] }}
```



###### Custom Facts

custom facts you can put on remote hosts

config file `/etc/ansible/facts.d`

fact files end in `.fact` and need to be in `/etc/ansible/facts.d/` directory on the remote host and must be executable.

<u>Example:</u>

```
[general]						(/etc/ansible/facts.d/custom.facts file on remote host)
package = httpd
service = httpd
state = started
enabled = true
```

```
"{{ ansible_facts['ansible_local']['custom']['general']['package'] }}      (in playbook) 
```



###### Magic Variables

Automatically set by ansible no -m or custom facts

most useful:

- hostvars							contains variables of host
- group_names                   list all groups the current managed hosts is in
- groups                               list all groups and hosts in the inventory
- inventory_hostname       host name for the current managed host as contained in the inventory file

---



##### Implementing Task Control

<a href="rh294.html">Top</a>

**Writing  Loops and Conditional Tasks**

using the `loop` keyword. Interating through items in a list.

###### <u>Simple Loop</u>s

```
- name: Postfix is running					(Getting 2 services to start on host)
  service:
    name: postfix
    state: started

- name: Dovecot is running
  service:
    name: dovecot
   state: started


- name: Postfix and Dovecot are running		(Using Loops to accomplish the same task)
  service:
    name: "{{ item }}"						(special variable name dont use anywhere else)
    state: started
  loop:
    - postfix
    - dovecot
	

vars:									  (Using variables with Loops to accomplish task)
mail_services:
	- postfix
	- dovecot
tasks:
	- name: Postfix and Dovecot are running
	service:
		name: "{{ item }}"						(special variable name dont use anywhere else)
		state: started
		loop: "{{ mail_services }}"
```

<u>Loops over a list of hashes or dictionaries</u>

```
- name: Users exist and are in the correct groups (run through making two users w/ loops)
  user:
    name: "{{ item.name }}"
    state: present
    groups: "{{ item.groups }}"
  loop:
    - name: jane
      groups: wheel
    - name: joe
      groups: root
```



###### Using Register Variables with Loops

a register keyword can also capture the output of tasks that loops.

<u>Structure</u>

```
- name: Loop Register Test
  gather_facts: no
  hosts: localhost
  tasks:
    - name: Looping Echo Task
      shell: "echo This is my item: {{ item }}"
      loop:
        - one
        - two
      register: echo_results							(registered value)
      
   - name: Show echo_results variable
     debug:											(debug shows variable on the screen)
       var: echo_results
```



###### Running Conditional Tasks

<a href="rh294.html">Top</a>

execute tasks or plays when certain conditions are met using the `when` statement

<u>Structure</u>

```
---
 - name: Simple Boolean Task Demo
   hosts: all
   vars:
     run_my_task: true							(sets boolean)
   tasks:
    - name: httpd package is installed
      yum:
        name: httpd
        when: run_my_task						(when statment,since run_my_task is true it will run)
   
   
---
  - name: Demonstrate the "in" keyword       (ansible_distribution is a fact from gathering facts)
    hosts: all
    gather_facts: yes
    vars:
      supported_distros:					(setting up a list to check for RedHat or Fedora on remote host)
        - RedHat
        - Fedora
    tasks:
      - name: Install httpd using yum, where supported
        yum:
          name: httpd
          state: present
        when: ansible_distribution in supported_distros  
```

**Example Conditions**

| Operation                           | Example                                                      |
| ----------------------------------- | ------------------------------------------------------------ |
| min, equal, max, not equal to       | ==, <, >, <=, >=, !=                                         |
| Variable Exists                     | <variable> is defined                                        |
| Variable does not exist             | <variable> is not defined                                    |
| Boolean , true                      | <variable>                                                   |
| Boolean, false                      | not <variable>                                               |
| First variable value is present     | ansible_distribution(single value) in supported_distros(defined list)    (see above example) |
| Operators within `when`             | or, and, ( use parenthasis to group sections)                |
| combine loops and conditional tasks | loop: "{{ ansible_mounts }}"                                 |
|                                     | when: item.mount == "/" and item.size_available > 20030      |



###### Implementing Handlers

<a href="rh294.html">Top</a>

tasks that respond to a notification triggered by other tasks. using the `handlers` and `notify` statements

<u>Structure</u>

```
tasks:
   - name: copy demo.example.conf configuration template
     template:
       src: /var/lib/templates/demo.example.conf.template
       dest: /etc/httpd/conf.d/demo.example.conf
     notify:											(notify statment)
       - restart apache									(handler name)
       
handlers:		   (handlers have 1 task tell another task to run, mostly used to restart services)	
   - name: restart apache
     service:
       name: httpd
       state: restarted
```



###### Handling Task Failure

<a href="rh294.html">Top</a>

Task error managing

| Description                                                  | Command                                                      |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| ignoring task failure                                        | ignore_errors: yes/no   (set on play not task)               |
| forcing execution of handlers after task failure             | force_handlers: yes    (set on play not task)                |
| specify task failure conditions (usually ran with command modules, based on command output) | failed_when: "'Failed message' in command_result.stdout"     |
| force a task failure with the `fail` module                  | fail:                                                        |
|                                                              | msg: "Fail message"                                          |
|                                                              | when: "'Fail message' in command_result.stdout"              |
| Control when a task reports that has changed. if a certain output is collected notify to run handlers. use false to not get a changed result | changed_when:                                                |
| Block and Error Handling using `block`, `rescue` and `always` | block defines main tasks to run, rescue defines the tasks to run if block fails, always define tasks that run no matter what. |

---



##### Deploying Files to Managed Hosts

<a href="rh294.html">Top</a>

###### File Modules

library included modules allowing you to accomplish most tasks related to file managment 

<u>Common Modules</u>

| Module      | Description                                     |
| ----------- | ----------------------------------------------- |
| blockinfile | insert,update or remove block of multiline text |
| copy        | copy a file from local or remote host           |
| fetch       | fetch files from remote host                    |
| file        | permissions, ownership, SElinux                 |
| lineinfile  | editing lines in a file                         |
| stat        | retrieve status info for a file                 |
| synchronize | similar to rsync                                |

###### Enusre File exists

```
file:
	path: /path/
	owner: user
	group: group
	mode: 0600					(permissions ####)
	state: touch				(if a file use touch it does not exsit and empty file will be created)
		 : directory			(will create if doesnt exist)
```

###### Modify file attributes (SElinux)

```
file:
	path: /path/
	setype: http_content_t					(set type of selinux)
```

###### Copying and Editing Files

```
copy:
	src: file
	dest: /path/to/remote
	force: yes/no				(optional) no - only copies the file if it does not exist)
	
fetch:							(pull a file from remote host)
	src: /src/file
	dest: /dest/file
	
lininfile:						(if line exists it will not add it)
	path: /path/to/file
	line: "Add this line to the file"
	state: present
	
blockinfile:					(add lines as seen (|) to a block)
	path: /path/to/file
	block: |
		first lines in the additional block of text
		second line in the additional block of text
	state: present
	
file:  							(remove file from host)
	dest: /path/to/file
	state: absent
	
	
stat:							(get stats of a file)
	path: /path
	checksum_algorithm: md5
register: result

-debug
	msg: "the checksum of the file is {{ result.stat.checksum }}"
	
	
synchronize:					(synchronize to remote host, mirror file to destination only changes are applied)
	src: file
	dest: /path/to/file
```



###### Deploying custom files with Jinja2 templates

<a href="rh294.html">Top</a>

modules are used to modify existing files, a more powerful way to manage files is to template them.

Ansible uses Jinja2 to template files. 

```
{# /etc/hosts line #}				(comment)
{{ ansible_facts['default_ipv4']['address']}} 	{{ ansible_facts['hostname']}} <EXPR>
```



###### Building Templates

Composed of data, variables, and expressions

use the `.j2` extention on templates. Set up on local control node and sent to remote hosts to modify files/configs

manage templates with `ansible_manage = Ansible managed` configured in ansible.cfg

<u>Deploy templates</u>

​		  template:

​					src: /j2-template.j2

​					dest: /dest-config-file.txt



<u>Jinja2 uses for statements to provide looping functionality</u>

​		{% for user in users %}

​				{{ user }}

​		{% endfor %}



<u>Jinja2 uses if statements to provide conditional control</u>

​		{% if finished %}

​		{{ result }}

​		{% endif %}



<u>Example</u> (modify the motd file on remote hosts) (playbook implementing template also shown)

```
#Template motd.j2 file system_owner is defined in the playbook, the rest are facts

This is the system {{ ansible_facts['fqdn'] }}.
This is a {{ ansible_facts['distribution'] }} version {{ ansible_facts['distribution_version'] }} system.
Only use this system with permission.
Please report issues to: {{ system_owner }}.

#Playbook Implentation

---
	- name: configure SOE
	  hosts: all
	  remote_user: devops
	  become: true
	  vars:
		- system_owner: clyde@example.com
	  tasks:
		- name: configure /etc/motd
		template:
			src: motd.j2
			dest: /etc/motd
			owner: root
			group: root
			mode: 0644
```

---



##### Managing Complex Plays and Playbooks

<a href="rh294.html">Top</a>

###### Selecting hosts with host patterns

used to specify the hosts to target by a play or ad hoc command. the name of the managed host or a host group in the inventory is a host pattern that specifies that host or host group.

```
- hosts: all
- hosts: ungrouped			
- hosts: 192.168.1.3  		(ip has to be in inventory)
- hosts: '*'				(wildcard, all hosts in inventory. always use '')
- hosts: '!host,host2'      (not these hosts)
- hosts: '*.example.com'	(will match hosts and host group)
- hosts: '192.168.1.*'
- hosts: 'host1,test2.example,192.168.1.*'  (list of hosts , seperated)
- hosts: 'host1,&host4'     (& means the host must match host1 and host4)
```

###### Including and Importing Files

if you have a long and complex playbook you can divide it up into smaller files and combine them into a main playbook. you reference other .yml files

<u>two methods</u> 

​	`include`	dynamic, proccesses during the run. Only runs when it gets to that part of the play

​			include_tasks to include a taks file into a play.

```
		-name: Install web server

		 hosts: webservers

		 tasks:

			-include_tasks: webserver_tasks.yml
```

​	`import`	static, proccesses when playbook is started 

​			import_playbook allows you to import external files containing a list of plays. used at top level

```
		-name: Prepare web server

		 import_playbook: web.yml
```

​			Importing and including tasks. 		

```
	   -name: Install web server`

		hosts: webserver

		tasks:

			-import_tasks: webserver_tasks.yml
```

​	

###### Defining Variables for external plays and tasks

reuse tasks and playbooks across an ansible environment. The tasks will be in a seperate file task.yml with just tasks

```
- name: import task file and set variables
  import_tasks: task.yml
  vars:
	package: httpd
	service: httpd
			
#task.yml
---
- name: Install the {{ package }} package
  yum:
  name: "{{ package }}"
  state: latest
  
- name: Start the {{ service }} service
  service:
    name: "{{ service }}"
    enabled: true
    state: started
```

---



##### Simplifying Playbooks with Roles

<a href="rh294.html">Top</a>

###### Role Structures

provides a way for you to make it easier to reuse ansible code generically.  you can package, in a standarized directory structure, all the tasks, variables, files, templates and other resources. 

copy directory (package) from project to project

```
role.example/
├── defaults				(low precedence and are *intended to change* overwritten in plays)
│
└── main.yml				(default variables can be overwritten by inventory variables)

├── files					(contains static files that refrence by role tasks)
├── handlers				(the main.yml contains the roles handler definitions)
│
└── main.yml

├── meta					(main.yml contians info about the role, author, license, role dependencies)
│
└── main.yml
├── README.md

├── tasks					(main.yml contians role's tasks definition)
│
└── main.yml

├── templates				(Jinja2 templates)

├── tests					(contains test and inventory playbooks to test)
│
├── inventory
│
└── test.yml

└── vars					(main.yml file defines the roles variable values)
└── main.yml				(role variables high presedence and cannot be overwritten by inventory variables)
```

###### Using Ansible Roles in Playbooks

```
- hosts: host1.example.com
  roles:
  	- role1
  	- role2
  # ansible looks in files, templates, or tasks first
  
 - hosts: host2.example.com   		(set role variables)
   roles:
   	 - role: role1
   	   var1: val1
   	   
 #Roles can be added to a play using ordinary task
 
 - name: A task to include role2 here
   include_role: role2
```

Tasks are executed as orderd in the task list. 

You can add the following to control the order of execution:

pre_tasks

pre_task handlers

roles

tasks

role handlers

task_handlers

post_tasks

post_task handlers

###### Reusing Content with system roles

<a href="rh294.html">Top</a>

ansible roles have been provided with OS `rhel-system-roles` package

helps standarize configuraitons betwen different versions of RHEL

`rhel-system-roles.<role>`

Found on Ansible Galaxy



<u>Installing RHEL System Roles</u>

verify any roles are available

`ansible-galaxy list`

Install

`yum install rhel-system-roles`

Location:	`ls -l /usr/share/ansibe/roles`

<u>Documentation</u>

`/usr/share/doc/rhel-system-roles`

<u>Example</u>

```
- name: Time Synchronization Play
  hosts: servers
  vars:
    timesync_ntp_servers:
      - hostname: 0.rhel.pool.ntp.org
        iburst: yes
      - hostname: 1.rhel.pool.ntp.org
        iburst: yes
      - hostname: 2.rhel.pool.ntp.org
        iburst: yes
    timezone: UTC
    
  roles:
    - rhel-system-roles.timesync
  tasks:
    - name: Set timezone
      timezone:
      name: "{{ timezone }}"
```

---



##### Creating Roles

<a href="rh294.html">Top</a>

- Create the role directory
- define the role content
- use the role in the playbook

Default path: `~/.ansible/roles` : `/usr/share/ansible/roles` : `/etc/ansible/roles`

you could have your roles in home directory (~/.ansible/roles) and system can have roles installed for all users in /usr/share/ansible/roles

###### Skeleton

`ansible-galaxy init my_new_role_name`

###### Role Dependencies

meta/main.yml

```
---
  dependencies:
    - role: apache
      port: 8080
    - role: postgres
      dbname: serverlist
      admin_user: felix
```

###### Role Behavior with Variables

well written roles use defulat variables. 

values of any variable defined in a roles defaults directory will be overwritten if that same variable is 

- defined in the inventory

- Yaml file `group_vars` or `host_vars`

- nested in the vars keywork

  vars:

  ​	system_owner: someon@example.com

  roles:

  ​	- role: motd

- as a varialbe included the roles keyword in play.

###### Deploying Roles with Ansible Galaxy

<a href="rh294.html">Top</a>

public library of ansible content. https://galaxy.ansible.com

​	has normal website functionality, search, filter, scoring, documentation

<u>Command Line</u>

​	`ansible-galaxy search '<name.role>' --platforms EL` 

​		EL - Enterprise Linux

​		--author, --platform, --galaxy-tags

​	`ansible-galaxy info <name.role>`

​	`ansible-galaxy install <name.role> -p roles/`

​		`-p` specifies directory to install 

​		`-r roles/requirements.yml` specify requirements in yml file

​		<u>3 Common requirements to use:</u>

```
		# from Ansible Galaxy, using the latest version
		- src: geerlingguy.redis
		
		# from Ansible Galaxy, overriding the name and using a specific version
		- src: geerlingguy.redis
		  version: "1.5.0"
		  name: redis_prod
		
		# supports 'http', 'https', or 'file' protocols share roles with others .tar
		- src: file:///opt/local/roles/myrole.tar
		  name: myrole
```

​	`ansible-galaxy list`  list roles

​	`ansible-galaxy remove <name.role>` remove roles

###### Getting roles and modules from content collections

<a href="rh294.html">Top</a>

are a distribution format for ansible content. a set of modules, roles, and plug-ins that you can download to your control node and use in your playbooks.

Ansible 2.9 or later support collections. 

Collection Sources : Ansible automation hub (red hat maintains/subscription needed) and Ansible Galaxy (community/public)

`ansible-galaxy collection install <.tar or http://example.com/.tar`

default locations: `~/.ansible/collections`: `/usr/share/ansible/collections`

​	`-p` for specific directory

​	`-r` requirements.yml 

```
			collections:

				-name: ansible.posix

		 		version: 1.2.0
```

###### Using collections

collections are stored in the `plugins/modules` directory in the `roles/` directory

refer by using `redhat.insights.insights_client`

ad hoc : `ansible localhost -m community.general.mail -a 'subject="Hellow World" to=root'`

<u>Playbook implementation:</u>

```
---
	- name: Create the operator1 user in the test database
	  hosts: db.example.com
	  tasks:
		- name: Ensure the operator1 database user is defined
		  community.mysql.mysql_user:    (collection)
		  	name: operator1
		  	password: Secret0451
		  	priv: '.:ALL'
		  	state: present
```

---

